USE dev

DECLARE @order BINARY(16)
--group
DECLARE @readyGlassGr BINARY(16)
DECLARE @promotionGr BINARY(16)
DECLARE @presentsGr BINARY(16)
DECLARE @jobsGr BINARY(16)
DECLARE @renovationGr BINARY(16)
DECLARE @sunGlassGr BINARY(16)
DECLARE @careProdGr BINARY(16)
--kind
DECLARE @accessories BINARY(16)
DECLARE @scleralLens BINARY(16)
DECLARE @softContactLens BINARY(16)
DECLARE @okl BINARY(16)
DECLARE @fr BINARY(16)
DECLARE @glassLens BINARY(16)
DECLARE @cert BINARY(16)
DECLARE @service BINARY(16)
--prop value
DECLARE @chlM BINARY(16)
DECLARE @chlW BINARY(16)
DECLARE @yngM BINARY(16)
DECLARE @yngW BINARY(16)
--goods
DECLARE @newbie BINARY(16)
DECLARE @customFr BINARY(16)
DECLARE @diffculDsgn BINARY(16)
DECLARE @certOnRecep BINARY(16)
--extra
DECLARE @ownRecipe BINARY(16)
DECLARE @recipeFromCusmtWords BINARY(16)

SET @order = ${order}

SET @readyGlassGr = 0x84A700025553E65311E3880DDB97E2BB 
SET @promotionGr = 0x80FF0CC47A5468A511E796C6F3F5774F
SET @presentsGr = 0x84A700025553E65311E388103BDADA3C
SET @jobsGr = 0x84A700025553E65311E3883086DE8A21
SET @renovationGr = 0x84A700025553E65311E38831B92903CB
SET @sunGlassGr = 0xB1C900025553E65311E397A9C3B8D4BA
SET @careProdGr = 0x84A700025553E65311E388392FD35316

SET @accessories = 0xB1C900025553E65311E399246D78B0C6
SET @scleralLens = 0xB3BBA4BF015829F711EB1A915DD78C0D
SET @softContactLens = 0xA56EE2F9827A1C414C0D2BBD0891E445
SET @okl = 0x9DEE4690686C34C64177884DD77D6F89
SET @fr = 0xA33D81520275761F4CEFA53EE9459485
SET @glassLens = 0xA2D3B2AC4F8B4B7C4088EE604F4C78A1
SET @cert = 0xB1C900025553E65311E39939B2990F6A
SET @service = 0xB1C900025553E65311E399246D78B0CC

SET @chlM = 0x81010CC47A5468A511E8A9E597B76ED3
SET @chlW = 0x81010CC47A5468A511E8A9E58D654BD7
SET @yngM = 0x81010CC47A5468A511E8A9E53B327187
SET @yngW = 0x81010CC47A5468A511E8A9E531BCDAB3

SET @newbie = 0x881B00269E587E4911E40CD1FAC4D468
SET @customFr = 0xB1C900025553E65311E397B59CC29E49
SET @diffculDsgn = 0x84A700025553E65311E38831B92903C8
SET @certOnRecep = 0x81040CC47A5468A511E91FCBD46C64AA

SET @ownRecipe = 0x8A5B00269E587E4911E42CF619EE339E
SET @recipeFromCusmtWords = 0x8A5B00269E587E4911E42CF6357B34D3

SELECT t1._IDRRef as REFFIELDRRef
INTO #tSunGlassesGrps 
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE ((t1._ParentIDRRef IN (@sunGlassGr)))
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE ((t2._IDRRef IN (@sunGlassGr)))

INSERT INTO #tSunGlassesGrps (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tSunGlassesGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tSunGlassesGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tSunGlassesGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tSunGlassesGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tSunGlassesGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tSunGlassesGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tSunGlassesGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tSunGlassesGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

SELECT t1._IDRRef as REFFIELDRRef
INTO #tReadyGlassesGrps
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE t1._ParentIDRRef IN (@readyGlassGr)
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE t2._IDRRef IN (@readyGlassGr)

INSERT INTO #tReadyGlassesGrps (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tReadyGlassesGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tReadyGlassesGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tReadyGlassesGrps (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tReadyGlassesGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tReadyGlassesGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

SELECT t1._IDRRef as REFFIELDRRef
INTO #tRenovationGrps
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE t1._ParentIDRRef IN (@renovationGr)
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE t2._IDRRef IN (@renovationGr)

INSERT INTO #tRenovationGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tRenovationGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tRenovationGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tRenovationGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tRenovationGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tRenovationGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tRenovationGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tRenovationGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tRenovationGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

SELECT t1._IDRRef as REFFIELDRRef
INTO #tJobsGrps
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE t1._ParentIDRRef IN (@jobsGr)
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE t2._IDRRef IN (@jobsGr)

INSERT INTO #tJobsGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tJobsGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tJobsGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tJobsGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tJobsGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tJobsGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL
 
SELECT t1._IDRRef as REFFIELDRRef
INTO #tcareProdGrps
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE t1._ParentIDRRef IN (@careProdGr)
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE t2._IDRRef IN (@careProdGr)

INSERT INTO #tCareProdGrps WITH(TABLOCK) (REFFIELDRRef) SELECT
t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tCareProdGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tCareProdGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tCareProdGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tCareProdGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tCareProdGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tCareProdGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tCareProdGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tCareProdGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

SELECT t1._IDRRef as REFFIELDRRef
INTO #tPromotionGrps
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE t1._ParentIDRRef IN (@promotionGr)
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE t2._IDRRef IN (@promotionGr)

INSERT INTO #tPromotionGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tPromotionGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tPromotionGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tPromotionGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tPromotionGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tPromotionGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

SELECT t1._IDRRef as REFFIELDRRef
INTO #tpresentsGrps
FROM dbo._Reference286 t1 WITH(NOLOCK)
WHERE t1._ParentIDRRef IN (@presentsGr)
UNION 
SELECT t2._IDRRef
FROM dbo._Reference286 t2 WITH(NOLOCK)
WHERE t2._IDRRef IN (@presentsGr)

INSERT INTO #tpresentsGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tpresentsGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tpresentsGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tpresentsGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tpresentsGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tpresentsGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

INSERT INTO #tpresentsGrps WITH(TABLOCK) (REFFIELDRRef) 
SELECT t1._IDRRef
FROM dbo._Reference286 t1 WITH(NOLOCK)
INNER JOIN #tpresentsGrps t2 WITH(NOLOCK)
ON t1._ParentIDRRef = t2.REFFIELDRRef
LEFT OUTER JOIN #tpresentsGrps t3 WITH(NOLOCK)
ON t1._IDRRef = t3.REFFIELDRRef
WHERE t3.REFFIELDRRef IS NULL

SELECT
	_order._IDRRef as ref,
	_order._Fld7891RRef as doctor
INTO #orders
FROM dbo._Document367 _order WITH(NOLOCK)
WHERE _order._IDRRef = @order

SELECT 
t2._Document367_IDRRef as ref,
	CASE 
		WHEN (t3._Fld6399RRef = @glassLens) THEN 1.0 
		WHEN (t3._Fld6399RRef = @fr) THEN 
			CASE 
				WHEN (
					t3._Fld17587_TYPE = 0x08 
					AND t3._Fld17587_L = 0x00 
					AND t3._Fld17587_N = 0.0 
					AND t3._Fld17587_T = '2001-01-01 00:00:00.000'
					AND t3._Fld17587_S = '' 
					AND t3._Fld17587_RTRef = 0x0000009E 
					AND t3._Fld17587_RRRef = @chlM) THEN 3.0 
				WHEN (
					t3._Fld17587_TYPE = 0x08 
					AND t3._Fld17587_L = 0x00 
					AND t3._Fld17587_N = 0.0 
					AND t3._Fld17587_T = '2001-01-01 00:00:00.000'
					AND t3._Fld17587_S = ''
					AND t3._Fld17587_RTRef = 0x0000009E 
					AND t3._Fld17587_RRRef = @chlW) THEN 4.0 
				WHEN (
					t3._Fld17587_TYPE = 0x08 
					AND t3._Fld17587_L = 0x00 
					AND t3._Fld17587_N = 0.0 
					AND t3._Fld17587_T = '2001-01-01 00:00:00.000' 
					AND t3._Fld17587_S = '' 
					AND t3._Fld17587_RTRef = 0x0000009E 
					AND t3._Fld17587_RRRef = @yngM) THEN 5.0 
				WHEN (
					t3._Fld17587_TYPE = 0x08 
					AND t3._Fld17587_L = 0x00 
					AND t3._Fld17587_N = 0.0 
					AND t3._Fld17587_T = '2001-01-01 00:00:00.000' 
					AND t3._Fld17587_S = '' 
					AND t3._Fld17587_RTRef = 0x0000009E 
					AND t3._Fld17587_RRRef = @yngW) THEN 6.0 
				WHEN (t3._IDRRef IN (SELECT t6.REFFIELDRRef AS REFFIELDRRef FROM #tSunGlassesGrps t6 WITH(NOLOCK))) THEN 8.0 
				WHEN (t3._IDRRef IN (SELECT t7.REFFIELDRRef AS REFFIELDRRef FROM #tReadyGlassesGrps t7 WITH(NOLOCK))) THEN 10.0 
				ELSE 2.0 
		END 
		WHEN (t3._Fld6399RRef = @softContactLens) THEN 7.0 
		WHEN (t3._Fld6399RRef = @accessories) THEN 
			CASE 
				WHEN (t3._Fld17587_TYPE = 0x08 AND t3._Fld17587_RTRef = 0x0000009E AND t3._Fld17587_RRRef IN (@chlM, @chlW)) THEN 19.0 
				ELSE 9.0 
			END 
		WHEN (t3._Fld6399RRef = @cert) THEN 11.0 
		WHEN (t3._IDRRef = @certOnRecep) THEN 12.0 
		WHEN (t3._Fld6399RRef = @okl) THEN 13.0 
		WHEN (t3._Fld6399RRef = @scleralLens) THEN 14.0 
		WHEN (t3._Fld6399RRef = @service) THEN 
			CASE 
				WHEN (t3._IDRRef IN (SELECT t8.REFFIELDRRef AS REFFIELDRRef FROM #tRenovationGrps t8 WITH(NOLOCK))) THEN 15.0 
				WHEN (t3._IDRRef IN (SELECT t9.REFFIELDRRef AS REFFIELDRRef FROM #tJobsGrps t9 WITH(NOLOCK))) THEN 16.0 
				ELSE 0.0 
			END 
		WHEN (t3._IDRRef = @diffculDsgn) THEN 17.0 
		WHEN (t3._IDRRef IN (SELECT t10.REFFIELDRRef AS REFFIELDRRef FROM #tcareProdGrps t10 WITH(NOLOCK))) THEN 18.0 
		WHEN (t3._IDRRef IN (SELECT t11.REFFIELDRRef AS REFFIELDRRef FROM #tPromotionGrps t11 WITH(NOLOCK))) THEN 20.0 
		WHEN (t3._IDRRef IN (SELECT t12.REFFIELDRRef AS REFFIELDRRef FROM #tpresentsGrps t12 WITH(NOLOCK))) THEN 21.0 
		WHEN (t1.doctor = @ownRecipe) THEN 22.0 
		WHEN (t3._IDRRef = @newbie) THEN 25.0 
		WHEN (t3._IDRRef = @customFr) THEN 26.0 
		WHEN (t1.doctor = @recipeFromCusmtWords) THEN 27.0 
		ELSE 0.0 
	END as segment,
	ISNULL(t5._Description,'') as brand
INTO #segments
FROM #orders t1 WITH(NOLOCK)
LEFT OUTER JOIN dbo._Document367_Vt7895 t2 WITH(NOLOCK)
LEFT OUTER JOIN dbo._Reference286 t3 WITH(NOLOCK)
ON t2._Fld7898RRef = t3._IDRRef
ON t1.ref= t2._Document367_IDRRef
LEFT OUTER JOIN dbo._Reference286 t4 WITH(NOLOCK)
ON t2._Fld7898RRef = t4._IDRRef 
LEFT OUTER JOIN dbo._Reference123 t5 WITH(NOLOCK)
ON t4._Fld6410RRef = t5._IDRRef

SELECT
	_segment.ref,
	CAST(_segment.segment AS INT) AS segment,
	_segment.brand
FROM #segments AS _segment

DROP TABLE #segments
DROP TABLE #tpresentsGrps
DROP TABLE #tCareProdGrps
DROP TABLE #tPromotionGrps
DROP TABLE #tJobsGrps
DROP TABLE #tReadyGlassesGrps
DROP TABLE #tRenovationGrps
DROP TABLE #tSunGlassesGrps 
DROP TABLE #orders